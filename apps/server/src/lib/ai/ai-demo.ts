/**
 * AI Assistant Demo and Examples
 *
 * This file demonstrates how to use the new AI workflow-based assistant system
 * and provides examples for different use cases.
 */

import { Mastra } from '@mastra/core';
import { RuntimeContext } from '@mastra/core/runtime-context';
import { assistantWorkflow } from './ai-workflow';
import {
  AssistantWorkflowInput,
  AssistantWorkflowOutput,
} from '@colanode/server/types/ai';

/**
 * Process an AI request using the Mastra workflow directly.
 *
 * @param request - The user's request with context
 * @returns Promise resolving to the assistant's response
 */
async function processAIRequest(
  request: AssistantWorkflowInput
): Promise<AssistantWorkflowOutput> {
  const startTime = Date.now();

  // Prepare runtime context
  const runtimeContext = new RuntimeContext();
  runtimeContext.set('workspaceName', request.workspaceId);
  runtimeContext.set('userName', request.userDetails.name);
  runtimeContext.set('userEmail', request.userDetails.email);
  runtimeContext.set('workspaceId', request.workspaceId);
  runtimeContext.set('userId', request.userId);
  runtimeContext.set(
    'selectedContextNodeIds',
    request.selectedContextNodeIds || []
  );
  runtimeContext.set('userInput', request.userInput);

  // Initialize Mastra and get the workflow
  const mastra = new Mastra({
    workflows: {
      assistantWorkflow,
    },
  });
  const workflow = mastra.getWorkflow('assistantWorkflow');
  const run = await workflow.createRunAsync();

  // Execute the workflow
  const result = await run.start({
    inputData: request,
    runtimeContext,
  });

  if (result.status !== 'success' || !result.result) {
    const errorMessage =
      result.status === 'suspended'
        ? 'Workflow was suspended unexpectedly'
        : (result as any).error || 'Workflow execution failed';
    console.error('‚ùå Workflow failed:', errorMessage);
    throw new Error(errorMessage);
  }

  return {
    ...result.result,
    processingTimeMs: Date.now() - startTime,
  };
}

/**
 * Demo: Basic AI Assistant Usage
 *
 * Shows how to use the AI service for simple requests
 */
export async function demoBasicUsage() {
  console.log('\nü§ñ === Basic AI Assistant Usage Demo ===');

  try {
    const response = await processAIRequest({
      userInput: 'What are the latest documents about project management?',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'John Doe',
        email: 'john@example.com',
      },
    });

    console.log(
      'üìù User Query:',
      'What are the latest documents about project management?'
    );
    console.log('ü§ñ AI Response:', response.finalAnswer);
    console.log('üîç Search Performed:', response.searchPerformed);
    console.log('‚è±Ô∏è Processing Time:', `${response.processingTimeMs}ms`);
    console.log('üìö Citations:', response.citations.length);
  } catch (error) {
    console.error('‚ùå Demo failed:', error);
  }
}

/**
 * Demo: Complex Database Query Processing
 *
 * Shows how the service handles complex database queries
 */
export async function demoComplexDatabaseQuery() {
  console.log('\nüóÑÔ∏è === Complex Database Query Demo ===');

  try {
    const response = await processAIRequest({
      userInput:
        'Can you help me understand the Q3 sales data from our database?',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'Jane Smith',
        email: 'jane@example.com',
      },
    });

    console.log(
      'üìù User Query:',
      'Can you help me understand the Q3 sales data from our database?'
    );
    console.log('ü§ñ AI Response:', response.finalAnswer);
    console.log('üîç Search Performed:', response.searchPerformed);
    console.log('‚è±Ô∏è Processing Time:', `${response.processingTimeMs}ms`);
    console.log('üìö Citations Found:', response.citations.length);
  } catch (error) {
    console.error('‚ùå Complex query demo failed:', error);
  }
}

/**
 * Demo: Workflow System Usage
 *
 * Shows how the new workflow system handles different types of queries
 */
export async function demoWorkflowUsage() {
  console.log('\nüîÑ === Workflow System Demo ===');

  try {
    // Test general knowledge query (no_context intent)
    console.log('\nüìö Testing general knowledge query...');
    const generalResponse = await processAIRequest({
      userInput: 'What is TypeScript and why is it useful?',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'John Doe',
        email: 'john@example.com',
      },
    });

    console.log('üìù Query: What is TypeScript and why is it useful?');
    console.log(
      'ü§ñ Response:',
      generalResponse.finalAnswer.substring(0, 200) + '...'
    );
    console.log('üîç Search Performed:', generalResponse.searchPerformed);
    console.log('üìö Citations:', generalResponse.citations.length);

    // Test workspace-specific query (retrieve intent)
    console.log('\nüîç Testing workspace-specific query...');
    const workspaceResponse = await processAIRequest({
      userInput: 'Show me recent documents about project planning',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'Jane Smith',
        email: 'jane@example.com',
      },
    });

    console.log('üìù Query: Show me recent documents about project planning');
    console.log(
      'ü§ñ Response:',
      workspaceResponse.finalAnswer.substring(0, 200) + '...'
    );
    console.log('üîç Search Performed:', workspaceResponse.searchPerformed);
    console.log('üìö Citations:', workspaceResponse.citations.length);
  } catch (error) {
    console.error('‚ùå Workflow demo failed:', error);
  }
}

/**
 * Demo: Error Handling
 *
 * Shows how the system handles various error scenarios
 */
export async function demoErrorHandling() {
  console.log('\n‚ö†Ô∏è === Error Handling Demo ===');

  // Test with invalid workspace ID
  try {
    console.log('Testing with invalid workspace ID...');
    const response = await processAIRequest({
      userInput: 'Test query',
      workspaceId: 'invalid_workspace',
      userId: 'test_user',
      userDetails: {
        name: 'Test User',
        email: 'test@example.com',
      },
    });

    console.log('ü§ñ Response (graceful error):', response.finalAnswer);
    console.log('‚è±Ô∏è Processing Time:', `${response.processingTimeMs}ms`);
  } catch (error) {
    console.log(
      '‚ùå Handled error gracefully:',
      error instanceof Error ? error.message : 'Unknown error'
    );
  }

  // Test with empty input
  try {
    console.log('Testing with empty input...');
    const response = await processAIRequest({
      userInput: '',
      workspaceId: 'demo_workspace_123',
      userId: 'test_user',
      userDetails: {
        name: 'Test User',
        email: 'test@example.com',
      },
    });

    console.log('ü§ñ Response (empty input):', response.finalAnswer);
  } catch (error) {
    console.log(
      '‚ùå Handled empty input gracefully:',
      error instanceof Error ? error.message : 'Unknown error'
    );
  }
}

/**
 * Demo: Performance Testing
 *
 * Shows performance characteristics with different query types
 */
export async function demoPerformance() {
  console.log('\n‚ö° === Performance Testing Demo ===');

  const queries = [
    { type: 'General Knowledge', query: 'What is TypeScript?' },
    { type: 'Simple Workspace', query: 'Show me recent documents' },
    {
      type: 'Complex Database',
      query: 'Find all projects where status is completed and priority is high',
    },
  ];

  for (const { type, query } of queries) {
    try {
      console.log(`\nüî¨ Testing ${type} query...`);
      console.log(`üìù Query: "${query}"`);

      const startTime = Date.now();
      const response = await processAIRequest({
        userInput: query,
        workspaceId: 'demo_workspace_123',
        userId: 'perf_test_user',
        userDetails: {
          name: 'Performance Tester',
          email: 'perf@example.com',
        },
      });
      const totalTime = Date.now() - startTime;

      console.log('üîç Search Performed:', response.searchPerformed);
      console.log('‚è±Ô∏è Service Time:', `${response.processingTimeMs}ms`);
      console.log('‚è±Ô∏è Total Time:', `${totalTime}ms`);
      console.log(
        'üìè Response Length:',
        `${response.finalAnswer.length} chars`
      );
    } catch (error) {
      console.error(`‚ùå Performance test failed for ${type}:`, error);
    }
  }
}

/**
 * Demo: New Workflow Architecture
 *
 * Shows the new declarative workflow with proper branching
 */
export async function demoNewWorkflowArchitecture() {
  console.log('\nüèóÔ∏è === New Workflow Architecture Demo ===');

  try {
    // Test 1: No-context branch (general knowledge)
    console.log('\n1Ô∏è‚É£ Testing NO_CONTEXT branch (general knowledge)...');
    const generalResponse = await processAIRequest({
      userInput: 'What is TypeScript and why should I use it?',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'Alice Developer',
        email: 'alice@example.com',
      },
    });

    console.log('üìù Query: "What is TypeScript and why should I use it?"');
    console.log('üéØ Expected Branch: no_context');
    console.log(
      'üîç Search Performed:',
      generalResponse.searchPerformed ? '‚ùå Unexpected' : '‚úÖ None (correct)'
    );
    console.log(
      'üìö Citations:',
      generalResponse.citations.length === 0
        ? '‚úÖ None (correct)'
        : '‚ùå Unexpected'
    );
    console.log(
      'üí¨ Response Preview:',
      generalResponse.finalAnswer.substring(0, 150) + '...'
    );

    // Test 2: Retrieve branch (workspace-specific)
    console.log('\n2Ô∏è‚É£ Testing RETRIEVE branch (workspace-specific)...');
    const workspaceResponse = await processAIRequest({
      userInput: 'Show me recent documents about project planning',
      workspaceId: 'demo_workspace_123',
      userId: 'demo_user_456',
      userDetails: {
        name: 'Bob Manager',
        email: 'bob@example.com',
      },
    });

    console.log('üìù Query: "Show me recent documents about project planning"');
    console.log('üéØ Expected Branch: retrieve');
    console.log(
      'üîç Search Performed:',
      workspaceResponse.searchPerformed
        ? '‚úÖ Yes (correct)'
        : '‚ùå None (unexpected)'
    );
    console.log(
      'üìö Citations:',
      workspaceResponse.citations.length > 0
        ? '‚úÖ Present (good)'
        : '‚ö†Ô∏è None (no results)'
    );
    console.log(
      'üí¨ Response Preview:',
      workspaceResponse.finalAnswer.substring(0, 150) + '...'
    );

    console.log('\n‚úÖ New workflow architecture demo completed successfully!');
  } catch (error) {
    console.error('‚ùå New workflow architecture demo failed:', error);
  }
}

/**
 * Run all demos including new architecture demonstrations
 *
 * Executes all demo functions to show the complete system capabilities
 */
export async function runAllDemos() {
  console.log('üé¨ === AI Assistant System Demo Suite ===');
  console.log('This demo showcases the new Mastra-based AI assistant system\n');

  try {
    // Show the migration comparison first
    showMigrationComparison();

    // Demo new architecture
    await demoNewWorkflowArchitecture();

    // Run original demos for compatibility
    await demoBasicUsage();
    await demoWorkflowUsage();
    await demoErrorHandling();
    await demoPerformance();

    console.log('\nüéâ === All Demos Completed Successfully ===');
    console.log('The new Mastra-based AI system is ready for production! üöÄ');
  } catch (error) {
    console.error('‚ùå Demo suite failed:', error);
  }
}

/**
 * Migration comparison showing before vs after
 */
export function showMigrationComparison() {
  console.log(`
üîÑ === MASTRA MIGRATION COMPLETED ===

üìä BEFORE (Complex LangChain System):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ùå 600+ lines across multiple complex files             ‚îÇ
‚îÇ ‚ùå Manual LangGraph workflow with 14+ imperative nodes  ‚îÇ
‚îÇ ‚ùå Complex state management between workflow steps      ‚îÇ
‚îÇ ‚ùå Monolithic agents with multi-purpose prompts         ‚îÇ
‚îÇ ‚ùå Tightly coupled search and reranking logic           ‚îÇ
‚îÇ ‚ùå Poor observability and debugging capabilities        ‚îÇ
‚îÇ ‚ùå Not optimized for smaller/self-hosted LLMs           ‚îÇ
‚îÇ ‚ùå Difficult to test, maintain, and extend              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üìä AFTER (Declarative Mastra Workflow System):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Fully declarative workflow with proper branching     ‚îÇ
‚îÇ ‚úÖ Single-purpose agents optimized for smaller LLMs     ‚îÇ
‚îÇ ‚úÖ Granular tools with focused responsibilities         ‚îÇ
‚îÇ ‚úÖ Intelligent intent-based routing                     ‚îÇ
‚îÇ ‚úÖ Full observability through Mastra's workflow engine  ‚îÇ
‚îÇ ‚úÖ Type-safe, maintainable, and easily extensible      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üéØ KEY ACHIEVEMENTS:
‚Ä¢ TRUE Mastra idiomatic implementation with .branch() routing
‚Ä¢ BYOM (Bring Your Own Model) optimization for self-hosted LLMs
‚Ä¢ Granular tools: semantic search, keyword search, database tools
‚Ä¢ Step-by-step observability for debugging and optimization

üèóÔ∏è ARCHITECTURE HIGHLIGHTS:
‚Ä¢ Declarative workflow: intentClassification ‚Üí branch(intent) ‚Üí publish
‚Ä¢ Simplified agents: intentClassifier, queryOptimizer, answerGenerator

üìÅ REFACTORED FILE STRUCTURE:
‚îú‚îÄ‚îÄ ai-workflow.ts    ‚Üí Declarative Mastra workflow with branching
‚îú‚îÄ‚îÄ ai-agents.ts      ‚Üí Single-purpose agents optimized for small LLMs
‚îú‚îÄ‚îÄ ai-tools.ts       ‚Üí Granular tools (semantic, keyword, database)
‚îú‚îÄ‚îÄ ai-models.ts      ‚Üí Multi-provider model configuration
‚îî‚îÄ‚îÄ ai-demo.ts        ‚Üí Workflow path demonstrations
`);
}

// Run demos if this file is executed directly
if (require.main === module) {
  async function main() {
    try {
      showMigrationComparison();

      console.log(
        '\n‚ö†Ô∏è  Note: These demos require valid workspace and user IDs to run properly.'
      );
      console.log(
        'To run actual demos, update the IDs in the demo functions and uncomment the line below.\n'
      );

      // Uncomment to run actual demonstrations (requires valid workspace/user IDs)
      // await runAllDemos();
    } catch (error) {
      console.error('Demo error:', error);
    }
  }

  main();
}
